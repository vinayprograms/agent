Apply minimal code changes to make failing tests pass.

Guidelines:
- Only change what is necessary
- Do not modify tests unless they have bugs
- Follow existing code style and patterns
- Keep changes focused and reviewable
